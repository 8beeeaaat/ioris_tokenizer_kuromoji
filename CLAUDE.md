# CLAUDE.md

  This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

  This is `@ioris/tokenizer-kuromoji`, a specialized tokenizer library for Japanese lyrics analysis that integrates with the
  `@ioris/core` framework. The library provides intelligent text segmentation for lyrics using the Kuromoji morphological
  analyzer, focusing on natural phrase breaks and proper handling of mixed Japanese/English content.

## Common Development Commands

### Build and Development

- `npm run dev` - Development mode using ts-node
- `npm run build` - Full build process (creates dist/ directory with .mjs and .d.ts files)
- `npm run build:esbuild` - ESBuild compilation only
- `npm run build:types` - TypeScript declaration files only

### Code Quality

- `npm run lint` - Run all linting (Biome + TypeScript)
- `npm run lint:biome` - Biome linting and formatting check
- `npm run lint:ts` - TypeScript type checking
- `npm run format` - Auto-fix formatting with Biome

### Testing

- `npm run test` - Run all Vitest tests

## High-Level Architecture

### Core Components

  **Main Entry (`src/index.ts`)**

- Simple re-export of the main tokenizer functionality

  **Tokenizer Engine (`src/Tokenizer.Kuromoji.ts`)**

- `LineArgsTokenizer()` - Main tokenization function that processes timeline data
- `TokenizeRule` interface - Defines rule structure for break point detection
- Complex rule matching engine based on:
  - Part-of-speech (POS) analysis from Kuromoji
  - Surface form patterns (regex matching)
  - Length constraints and positioning logic
  - Context awareness (before/current/after token relationships)

  **Rule System (`src/rules.ts`)**

- `DEFAULT_BRAKE_RULES` - Comprehensive ruleset for natural line breaks
- `DEFAULT_WHITESPACE_RULES` - Rules for whitespace handling
- Multiple regex patterns for different character types (Hiragana, Katakana, Kanji, alphabet, etc.)

### Key Architectural Patterns

  **Timeline-Based Processing**

- Input: `WordTimeline[]` with timing information (`begin`, `end`, `text`)
- Output: `Map<number, CreateLineArgs>` with segmented lines and break points
- Preserves temporal relationships while adding logical segmentation

  **Rule-Based Segmentation**

- Rules target specific linguistic patterns using Kuromoji's IpadicFeatures
- Support for complex conditions: length constraints, position awareness, context matching
- Special handling for parentheses, quotes, and mixed-language content

  **Integration with @ioris/core**

- Uses `CreateLineArgs` interface for output compatibility
- Maintains `WordTimeline` structure with additional `hasNewLine` and `hasWhitespace` flags
- Generates UUIDs for word identification

### Dependencies and Tools

  **Core Dependencies**

- `@ioris/core` - Framework integration and data structures
- `kuromoji` - Japanese morphological analyzer

  **Build System**

- ESBuild for bundling (outputs ESM format)
- TypeScript for type definitions
- Biome for linting and formatting
- Vitest for testing

### Testing Strategy

  The test suite (`src/Tokenizer.Kuromoji.test.ts`) includes:

- Comprehensive lyrics test cases (100+ real-world examples)
- Comparison between tokenized and non-tokenized results
- Mixed Japanese/English content validation
- Special character and punctuation handling

### Special Considerations

  **Lyrics-Specific Logic**

- Handles parentheses and quotes as phrase boundaries
- Processes repetitive patterns (e.g., "Baby Baby Baby")
- Manages mixed script transitions (Japanese â†” English)
- Respects natural linguistic breaks in song lyrics

  **Performance Characteristics**

- Processes tokens sequentially for context awareness
- Uses regex compilation and map-based lookups for efficiency
- Debug mode available via `NODE_ENV !== "production"`

## Development Guidelines

### When Adding New Rules

1. Add regex patterns to `src/rules.ts` if needed
2. Define rule structure in `DEFAULT_BRAKE_RULES` array
3. Test with representative lyrics samples
4. Consider impact on mixed-language content

### When Modifying Core Logic

1. Understand the timeline preservation requirements
2. Maintain compatibility with `@ioris/core` interfaces
3. Run full test suite to validate against lyric corpus
4. Check debug output for rule matching behavior

### File Structure Notes

- `src/` contains all source TypeScript files
- `dist/` is generated by build process (ESM modules + type definitions)
- Tests are co-located with source files using `.test.ts` suffix
- Build configuration in `build.ts` using ESBuild
